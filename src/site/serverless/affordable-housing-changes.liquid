---
layout: layouts/base.liquid
title: Check for Affordable Housing Updates
permalink: 
  build: "/housing/affordable-housing/changes/index.html"
---

{% assign allFields = "foo" | housingFields %}
{% assign housingFields = allFields.housingDatabase %}
{% assign unitsFields = allFields.units %}


<form style="display:block;" id="housing-changes" name="housing_changes" netlify>
<input type="hidden" name="form-name" value="housing_changes" />

<div id="property-data">
{% fieldLabel "Property Name", housingFields, "APT_NAME" %}
{% formField housingFields, "APT_NAME" %}<br/>

{% fieldLabel "Address", housingFields, "ADDRESS" %}
{% formField housingFields, "ADDRESS" %}<br/>
<div id="show-second-address">
<a href="javascript:showSecondAddress()">Add a second address</a>
</div>
<div id="second-address" hidden>
{% fieldLabel "Second address", housingFields, "SECOND_ADDRESS" %}
{% formField housingFields, "SECOND_ADDRESS" %}<br/>
</div>

{% fieldLabel "City", housingFields, "CITY" %}
{% formField housingFields, "CITY" %}<br/>

{% fieldLabel "ZIP Code", housingFields, "ZIP_CODE" %}
{% formField housingFields, "ZIP_CODE" %}<br/>

{% fieldLabel "Contact Phone", housingFields, "PHONE" %}
{% formField housingFields, "PHONE" %}<br/>

{% fieldLabel "Contact Email", housingFields, "EMAIL" %}
{% formField housingFields, "EMAIL" %}<br/>

{% fieldLabel "Management Company", housingFields, "MANAGEMENT_COMPANY" %}
{% formField housingFields, "MANAGEMENT_COMPANY" %}<br/>

{% fieldLabel "URL", housingFields, "PROPERTY_URL" %}
{% formField housingFields, "PROPERTY_URL" %}<br/>

{% fieldLabel "Total Units", housingFields, "UNITS_CNT" %}
{% formField housingFields, "UNITS_CNT" %}<br/>

<div class="multiselect">
{% fieldLabel "Populations Served", housingFields, "POPULATIONS_SERVED" %}<br/>
{% formField housingFields, "POPULATIONS_SERVED" %}<br/>
</div>

{% fieldLabel "Minimum Resident Age", housingFields, "MIN_RESIDENT_AGE" %}
{% formField housingFields, "MIN_RESIDENT_AGE" %}<br/>

{% fieldLabel "Maximum Resident Age", housingFields, "MAX_RESIDENT_AGE" %}
{% formField housingFields, "MAX_RESIDENT_AGE" %}<br/>

{% fieldLabel "Accepts Vouchers", housingFields, "ACCEPTS_VOUCHERS" %}
{% formField housingFields, "ACCEPTS_VOUCHERS" %}<br/>

{% fieldLabel "Wheelchair Accessible Units", housingFields, "HAS_WHEELCHAIR_ACCESSIBLE_UNITS" %}
{% formField housingFields, "HAS_WHEELCHAIR_ACCESSIBLE_UNITS" %}<br/>

{% fieldLabel "Only accepts referral applications", housingFields, "DISALLOWS_PUBLIC_APPLICATIONS" %}
{% formField housingFields, "DISALLOWS_PUBLIC_APPLICATIONS" %}<br/>

{% fieldLabel "Prefers applicants within the local city", housingFields, "PREFERS_LOCAL_APPLICANTS" %}
{% formField housingFields, "PREFERS_LOCAL_APPLICANTS" %}<br/>
</div>

<div id="all-units">
{% for unitNum in (0..9) %}
	<div id="unit-{{unitNum}}">
	<fieldset>
	  <legend>Unit Offering 
	    <button type="button">Delete</button>
	  </legend>
	{% indexFieldLabel unitNum, "Type", unitsFields, "TYPE" %}
	{% indexFormField unitNum, unitsFields, "TYPE" %}<br/>

	{% indexFieldLabel unitNum, "Status", unitsFields, "STATUS" %}
	{% indexFormField unitNum, unitsFields, "STATUS" %}<br/>

  Occupancy
	{% indexFieldLabel unitNum, "Min", unitsFields, "MIN_OCCUPANCY" %}
	{% indexFormField unitNum, unitsFields, "MIN_OCCUPANCY" %} to 

  {% indexFieldLabel unitNum, "Max", unitsFields, "MAX_OCCUPANCY" %}
	{% indexFormField unitNum, unitsFields, "MAX_OCCUPANCY" %} people<br/>

	{% indexFieldLabel unitNum, "Percent AMI", unitsFields, "PERCENT_AMI" %}
	{% indexFormField unitNum, unitsFields, "PERCENT_AMI" %}%<br/>

	{% indexFieldLabel unitNum, "Rent", unitsFields, "RENT_PER_MONTH_USD" %}
	${% indexFormField unitNum, unitsFields, "RENT_PER_MONTH_USD" %} per month<br/>

	{% indexFieldLabel unitNum, "Minimum Income", unitsFields, "MIN_INCOME_RENT_FACTOR" %} = 
	{% indexFormField unitNum, unitsFields, "MIN_INCOME_RENT_FACTOR" %} times yearly rent<br/>

	<table id="max-income">
	<tr>
	<th>Household Size</th>
	<th>Maximum Income</th>
	</tr>
	{% for hhSize in (1..12) %}
	<tr>
	{% assign fieldname = "MAX_YEARLY_INCOME_HH_" | append: hhSize | append: "_USD" %}
	<td>{% indexFieldLabel unitNum, hhSize, unitsFields, fieldname %}</td>
	<td>${% indexFormField unitNum, unitsFields, fieldname %} per year</td>
	</tr>
	{% endfor %}
	</table>
	</fieldset>
	</div>
{% endfor %}
</div>

<button type="button" onclick="addUnit();">Add new unit offering</button>
<br/>
<a href="changes" id="reset-link">Reset</a> <button type="submit">Submit</button>
</form>

<script>

function addUnit() {
  if (unitIdx < 9) {
    unitIdx++;
    let newUnit = document.querySelectorAll("#all-units > div")[unitIdx];
    newUnit.removeAttribute("hidden");
    //document.getElementById("unit-" + (numUnits - 1)).removeAttribute("hidden");
  }
}

function clearUnitForm(unitDiv) {
	let allInputs = unitDiv.querySelectorAll("input, textarea, select");
	for (input of allInputs) {
	  if (input.tagName == "TEXTAREA") {
	    input.innerHTML = "";
	  } else if (input.tagName == "SELECT") {
	    let options = input.childNodes;
	    for (option of options) {
	      option.removeAttribute("selected");
	    }
	    input.firstChild.setAttribute("selected", "selected");
	  } else if (input.tagName == "INPUT") {
	    if (input.type == "checkbox") {
	      input.removeAttribute("checked");
	    } else {
	      input.value = "";
	    }
	  }
	}
}

function deleteUnit() {
  let deletedUnit = this.parentNode.parentNode.parentNode;
	if (unitIdx >= 0) {
	  deletedUnit.setAttribute("hidden", "hidden");
	  let unitsContainer = document.getElementById("all-units");
	  unitsContainer.appendChild(deletedUnit);
	  unitIdx--;
	  clearUnitForm(deletedUnit);
	}
}

function showSecondAddress() {
	document.getElementById("second-address").removeAttribute("hidden");
  document.getElementById("show-second-address").setAttribute("hidden", "hidden");
}

function updateSelectColor() {
	let options = this.childNodes;
	for (option of options) {
	  if (option.selected) {
	    let color = option.dataset.color;
	    if (color) {
	      this.style.backgroundColor = `var(--airtable-color-${color})`;
	    } else {
	      this.style.backgroundColor = "";
	    }
	  }
	}
}

function updateMultiselectColors() {
	let options = this.querySelectorAll("input[type=checkbox]");
	for (option of options) {
	  let label = option.nextSibling.nextSibling;
	  label.style.backgroundColor = "";
	  if (option.checked) {
	    let color = option.dataset.color;
	    if (color) {
	      label.style.backgroundColor = `var(--airtable-color-${color})`;
	    } 
	  }
	}
}

function prefillField(field, value) {
	let isMultiselect = field.parentNode.className == "multiselect";
  if (!value) { return; }
  if (field.tagName == "INPUT") {
    if (field.type == "checkbox") {
      let doCheck = false;
      if (isMultiselect) {
        doCheck = value.includes(field.value);
      } else {
        doCheck = value;
      }
      if (doCheck) {
        field.setAttribute("checked", "checked");
      }
    } else {
      field.value = value;
    }
  } else if (field.tagName == "TEXTAREA") {
    field.innerHTML = value;
  } else if (field.tagName == "SELECT") {
    for (option of field.childNodes) {
      if (option.value == value) {
        option.setAttribute("selected", "selected");
        break;
      }
    }
  } 
  let fieldChanged = field;
  if (isMultiselect) {
    fieldChanged = field.parentNode;
  }
  if (fieldChanged.onchange) {
    fieldChanged.onchange();
  }
}

function prefillForm(data) {
  const fieldSelector = "input, textarea, select";
  let propertySection = document.getElementById("property-data");
  let unitsSection = document.getElementById("all-units");
	let propertyFields = propertySection.querySelectorAll(fieldSelector);
	console.log(propertyFields);
	let unitsFields = unitsSection.querySelectorAll(fieldSelector);
	
	for (field of propertyFields) {
	  let value = data.housing.fields[field.name];
	  prefillField(field, value);
	}

  for (field of unitsFields) {
    let [fieldName, index] = field.name.split(":");
    if (index < data.units.length) {
      let value = data.units[index].fields[fieldName];
      prefillField(field, value);
    }
  }
}

function initUnitVisibility(data) {
  let numUsedUnits = data.units.length;
	let units = document.querySelectorAll("#all-units > div");
  for (i = numUsedUnits; i < units.length; i++) {
    units[i].setAttribute("hidden", "hidden");
  }
}

function updateMaxIncomeVisibility() {
  console.log("updateMaxIncomeVisibility called.");
  let container = this.parentNode;
  let maxIncomeRows = container.querySelectorAll("#max-income tr");
  let minOccupancyField = container.querySelector("[name*=MIN_OCCUPANCY]");
  let maxOccupancyField = container.querySelector("[name*=MAX_OCCUPANCY]");
	let minHhSize = parseInt(minOccupancyField.value || 0);
  let maxHhSize = parseInt(maxOccupancyField.value || maxIncomeRows.length);
  for (j = 1; j < maxIncomeRows.length; j++) {
    // Skip the header row, start j at 1.
    if (j < minHhSize || j > maxHhSize) {
      maxIncomeRows[j].setAttribute("hidden", "hidden");
      maxIncomeRows[j].querySelector("input").value = "";
    } else {
      maxIncomeRows[j].removeAttribute("hidden");
    }
  }
}

let units = document.querySelectorAll("#all-units > div");
for (unit of units) {
	let deleteButton = unit.querySelector("button");
	deleteButton.onclick = deleteUnit;
}

let selects = document.querySelectorAll("#housing-changes select");
for (select of selects) {
	select.onchange = updateSelectColor;
}

let multiselects = document.querySelectorAll(".multiselect");
for (multiselect of multiselects) {
	multiselect.onchange = updateMultiselectColors;
}

let occupancies = document.querySelectorAll("[name*=OCCUPANCY]");
for (occupancy of occupancies) {
	occupancy.onchange = updateMaxIncomeVisibility;
}
console.log(occupancies);

let unitIdx = 0;
let urlParams = new URLSearchParams(window.location.search);
if (urlParams.has("id")) {
  let propertyId = urlParams.get("id");
	fetch("/housing/affordable-housing/rawdata/" + propertyId)
  .then(response => response.json())
  .then(data => {
    unitIdx = data.units.length - 1;
    prefillForm(data);
    initUnitVisibility(data);
  });
  document.getElementById("reset-link").href="changes?id=" + propertyId;
}



</script>


