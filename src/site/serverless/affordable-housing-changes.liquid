---
layout: layouts/base.liquid
title: Check for Affordable Housing Updates
permalink: 
  serverless: "/housing/affordable-housing/changes/:id"
  build: "/housing/affordable-housing/changes/index.html"
---

{% assign allFields = "foo" | housingFields %}
{% assign housingFields = allFields.housingDatabase %}
{% assign unitsFields = allFields.units %}
{% comment %}
{% assign record = eleventy.serverless.path.id | housingRecord %}
{% assign unitsRecords = eleventy.serverless.path.id | unitsRecords %}
{% endcomment %}

<form style="display:block;" id="housing-changes" name="housing_changes" netlify>
<input type="hidden" name="form-name" value="housing_changes" />

<div id="property-data">
{% fieldLabel "Property Name", housingFields, "APT_NAME" %}
{% formField housingFields, "APT_NAME" %}<br/>

{% fieldLabel "Address", housingFields, "ADDRESS" %}
{% formField housingFields, "ADDRESS" %}<br/>

{% fieldLabel "Second address", housingFields, "SECOND_ADDRESS" %}
{% formField housingFields, "SECOND_ADDRESS" %}<br/>

{% fieldLabel "City", housingFields, "CITY" %}
{% formField housingFields, "CITY" %}<br/>

{% fieldLabel "ZIP Code", housingFields, "ZIP_CODE" %}
{% formField housingFields, "ZIP_CODE" %}<br/>

{% fieldLabel "Contact Phone", housingFields, "PHONE" %}
{% formField housingFields, "PHONE" %}<br/>

{% fieldLabel "Contact Email", housingFields, "EMAIL" %}
{% formField housingFields, "EMAIL" %}<br/>

{% fieldLabel "Management Company", housingFields, "MANAGEMENT_COMPANY" %}
{% formField housingFields, "MANAGEMENT_COMPANY" %}<br/>

{% fieldLabel "URL", housingFields, "PROPERTY_URL" %}
{% formField housingFields, "PROPERTY_URL" %}<br/>

{% fieldLabel "Total Units", housingFields, "UNITS_CNT" %}
{% formField housingFields, "UNITS_CNT" %}<br/>

<div class="multiselect">
{% fieldLabel "Populations Served", housingFields, "POPULATIONS_SERVED" %}<br/>
{% formField housingFields, "POPULATIONS_SERVED" %}<br/>
</div>

{% fieldLabel "Minimum Resident Age", housingFields, "MIN_RESIDENT_AGE" %}
{% formField housingFields, "MIN_RESIDENT_AGE" %}<br/>

{% fieldLabel "Maximum Resident Age", housingFields, "MAX_RESIDENT_AGE" %}
{% formField housingFields, "MAX_RESIDENT_AGE" %}<br/>

{% fieldLabel "Accepts Vouchers", housingFields, "ACCEPTS_VOUCHERS" %}
{% formField housingFields, "ACCEPTS_VOUCHERS" %}<br/>

{% fieldLabel "Wheelchair Accessible Units", housingFields, "HAS_WHEELCHAIR_ACCESSIBLE_UNITS" %}
{% formField housingFields, "HAS_WHEELCHAIR_ACCESSIBLE_UNITS" %}<br/>
</div>

<div id="all-units">
{% for unitNum in (0..9) %}
	<div id="unit-{{unitNum}}">
	<fieldset>
	  <legend>Unit Offering 
	    <button type="button">Delete</button>
	  </legend>
	{% indexFieldLabel unitNum, "Type", unitsFields, "TYPE" %}
	{% indexFormField unitNum, unitsFields, "TYPE" %}<br/>

	{% indexFieldLabel unitNum, "Status", unitsFields, "STATUS" %}
	{% indexFormField unitNum, unitsFields, "STATUS" %}<br/>

  Occupancy
	{% indexFieldLabel unitNum, "Min", unitsFields, "MIN_OCCUPANCY" %}
	{% indexFormField unitNum, unitsFields, "MIN_OCCUPANCY" %} to 

  {% indexFieldLabel unitNum, "Max", unitsFields, "MAX_OCCUPANCY" %}
	{% indexFormField unitNum, unitsFields, "MAX_OCCUPANCY" %} people<br/>

	{% indexFieldLabel unitNum, "Percent AMI", unitsFields, "PERCENT_AMI" %}
	{% indexFormField unitNum, unitsFields, "PERCENT_AMI" %}%<br/>

	{% indexFieldLabel unitNum, "Rent", unitsFields, "RENT_PER_MONTH_USD" %}
	${% indexFormField unitNum, unitsFields, "RENT_PER_MONTH_USD" %} per month<br/>

	{% indexFieldLabel unitNum, "Minimum Income", unitsFields, "MIN_INCOME_RENT_FACTOR" %} = 
	{% indexFormField unitNum, unitsFields, "MIN_INCOME_RENT_FACTOR" %} times yearly rent<br/>

	<table>
	<th>Household Size</th>
	<th>Maximum Income</th>
	{% for hhSize in (1..12) %}
	<tr>
	{% assign fieldname = "MAX_YEARLY_INCOME_HH_" | append: hhSize | append: "_USD" %}
	<td>{% indexFieldLabel unitNum, hhSize, unitsFields, fieldname %}</td>
	<td>${% indexFormField unitNum, unitsFields, fieldname %} per year</td>
	</tr>
	{% endfor %}
	</table>
	</fieldset>
	</div>
{% endfor %}
</div>

<button type="button" onclick="addUnit();">Add new unit offering</button>
<br/>
<a href="{{serverless.path}}">Reset</a> <button type="submit">Submit</button>
</form>

<script>
let unitIdx = {{ unitsRecords | size | plus: -1}};

function addUnit() {
  if (unitIdx < 9) {
    unitIdx++;
    let newUnit = document.querySelectorAll("#all-units div")[unitIdx];
    newUnit.removeAttribute("hidden");
    //document.getElementById("unit-" + (numUnits - 1)).removeAttribute("hidden");
  }
}

function clearUnitForm(unitDiv) {
	let allInputs = unitDiv.querySelectorAll("input, textarea, select");
	for (input of allInputs) {
	  if (input.tagName == "TEXTAREA") {
	    input.innerHTML = "";
	  } else if (input.tagName == "SELECT") {
	    let options = input.childNodes;
	    for (option of options) {
	      option.removeAttribute("selected");
	    }
	    input.firstChild.setAttribute("selected", "selected");
	  } else if (input.tagName == "INPUT") {
	    if (input.type == "checkbox") {
	      input.removeAttribute("checked");
	    } else {
	      input.value = "";
	    }
	  }
	}
}

function deleteUnit() {
  let deletedUnit = this.parentNode.parentNode.parentNode;
	if (unitIdx >= 0) {
	  deletedUnit.setAttribute("hidden", "hidden");
	  let unitsContainer = document.getElementById("all-units");
	  unitsContainer.appendChild(deletedUnit);
	  unitIdx--;
	  clearUnitForm(deletedUnit);
	}
}

function updateSelectColor() {
	let options = this.childNodes;
	for (option of options) {
	  if (option.selected) {
	    let color = option.dataset.color;
	    if (color) {
	      this.style.backgroundColor = `var(--airtable-color-${color})`;
	    } else {
	      this.style.backgroundColor = "";
	    }
	  }
	}
}

function updateMultiselectColors() {
	let options = this.querySelectorAll("input[type=checkbox]");
	for (option of options) {
	  let label = option.nextSibling.nextSibling;
	  label.style.backgroundColor = "";
	  if (option.checked) {
	    let color = option.dataset.color;
	    if (color) {
	      label.style.backgroundColor = `var(--airtable-color-${color})`;
	    } 
	  }
	}
}

function prefillForm(data) {
  let propertySection = document.getElementById("property-data");
  let unitsSection = document.getElementById("all-units");
	let propertyFields = propertySection.querySelectorAll("input, textarea, select");
	let unitsFields = unitsSection.querySelectorAll("input, textarea, select");
	for (field of propertyFields) {
	  let value = data.housing.fields[field.name];
	  if (!value) { continue; }
    if (field.tagName == "INPUT") {
      field.value = value;
    } else if (field.tagName == "TEXTAREA") {
      field.innerHTML = value;
    } else if (field.tagName == "SELECT") {
	    for (option of field.childNodes) {
	      if (option.value == value) {
	        option.setAttribute("selected", "selected");
	        break;
	      }
	    }
    }
	}
}

let units = document.querySelectorAll("#all-units div");
for (unit of units) {
	let deleteButton = unit.querySelector("button");
	deleteButton.onclick = deleteUnit;
}

let selects = document.querySelectorAll("#housing-changes select");
for (select of selects) {
	select.onchange = updateSelectColor;
}

let multiselects = document.querySelectorAll(".multiselect");
for (multiselect of multiselects) {
	multiselect.onchange = updateMultiselectColors;
}

fetch("/housing/affordable-housing/rawdata/{{eleventy.serverless.path.id}}")
  .then(response => response.json())
  .then(data => prefillForm(data));


</script>


